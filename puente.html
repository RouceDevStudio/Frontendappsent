<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UpGames | Redirecci√≥n Segura</title>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <style>
        :root { --neon-green: #39FF14; --dark-bg: #0a0a0a; --card-bg: #1a1a1a; }
        body { background-color: var(--dark-bg); color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; overflow-x: hidden; }
        .container { background: var(--card-bg); padding: 30px; border-radius: 20px; border: 1px solid rgba(57, 255, 20, 0.2); box-shadow: 0 0 20px rgba(0,0,0,0.5); max-width: 90%; width: 450px; text-align: center; }
        h1 { color: var(--neon-green); font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; }
        p { color: #aaa; font-size: 0.9rem; line-height: 1.5; margin-bottom: 20px; }
        .ad-space { background: #000; border: 1px dashed var(--neon-green); padding: 40px 10px; margin: 20px 0; border-radius: 10px; color: #555; }
        #timer { font-size: 1.2rem; font-weight: bold; color: var(--neon-green); margin: 20px 0; }
        .btn-neon { background: var(--neon-green); color: #000; padding: 15px 40px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.3s; box-shadow: 0 0 15px rgba(57, 255, 20, 0.4); display: none; margin: 0 auto; }
        .btn-neon:hover { transform: scale(1.05); box-shadow: 0 0 25px var(--neon-green); }
        .btn-neon:disabled { opacity: 0.5; cursor: not-allowed; }
        .footer-note { font-size: 0.7rem; color: #444; margin-top: 30px; }
        .error-box { background: rgba(255, 67, 67, 0.1); border: 1px solid #ff4343; padding: 15px; border-radius: 10px; color: #ff4343; margin: 15px 0; }
        .success-box { background: rgba(57, 255, 20, 0.1); border: 1px solid var(--neon-green); padding: 15px; border-radius: 10px; color: var(--neon-green); margin: 15px 0; }
        .debug-info { background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 5px; font-size: 0.7rem; color: #666; margin-top: 15px; text-align: left; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <ion-icon name="shield-checkmark-outline" style="font-size: 48px; color: var(--neon-green);"></ion-icon>
        <h1>Saliendo de UpGames</h1>
        <p>Est√°s siendo redirigido a un servidor externo. Recuerda que UpGames es un directorio neutral y no almacena archivos.</p>
        
        <!-- ‚≠ê PUBLICIDAD 1 -->
        <script>
            atOptions = {
                'key': '0af19e39530f3a17d0722c5f0c91735a',
                'format': 'iframe',
                'height': 250,
                'width': 300,
                'params': {}
            };
        </script>
        <script src="https://www.highperformanceformat.com/0af19e39530f3a17d0722c5f0c91735a/invoke.js"></script><br /><br />

        <div id="timer">Preparando enlace en 30...</div>
        <div id="error-msg" class="error-box" style="display:none;"></div>
        <div id="success-msg" class="success-box" style="display:none;"></div>
        <button id="btn" class="btn-neon">Obtener Enlace</button><br />
        
        <!-- ‚≠ê PUBLICIDAD 2 -->
        <script async="async" data-cfasync="false" src="https://pl28635483.effectivegatecpm.com/d0ede3882435cb5a80915e26542fd8db/invoke.js"></script>
        <div id="container-d0ede3882435cb5a80915e26542fd8db"></div><br />

        <script>
          atOptions = {
            'key' : '247173c86298a1f5a8e01a0e1c5889cd',
            'format' : 'iframe',
            'height' : 600,
            'width' : 160,
            'params' : {}
          };
        </script>
        <script src="https://www.highperformanceformat.com/247173c86298a1f5a8e01a0e1c5889cd/invoke.js"></script>

        <div class="footer-note">
            La responsabilidad legal recae en el usuario que index√≥ el link.
        </div>
        
        <!-- DEBUG INFO (solo visible en desarrollo) -->
        <div id="debug-info" class="debug-info" style="display:none;"></div>
    </div>

    <script>
        // ‚≠ê CONFIGURACI√ìN
        const API_URL = "https://backendapp-037y.onrender.com";
        const DEBUG_MODE = false; // Cambiar a true para ver logs detallados
        
        // ‚≠ê ELEMENTOS DOM
        const timerEl = document.getElementById('timer');
        const btnEl = document.getElementById('btn');
        const errorEl = document.getElementById('error-msg');
        const successEl = document.getElementById('success-msg');
        const debugEl = document.getElementById('debug-info');
        
        // ‚≠ê ESTADO
        let countdown = 30;
        let enlaceFinal = null;
        let validacionRealizada = false;
        
        // ‚≠ê OBTENER PAR√ÅMETROS DE URL
        const urlParams = new URLSearchParams(window.location.search);
        const juegoId = urlParams.get('id');
        const destino = urlParams.get('dest'); // Fallback para formato antiguo
        
        // ‚≠ê FUNCI√ìN DE DEBUG
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            const logMsg = `[${timestamp}] ${emoji} ${msg}`;
            
            console.log(logMsg);
            
            if (DEBUG_MODE) {
                debugEl.style.display = 'block';
                debugEl.innerHTML += `<div>${logMsg}</div>`;
                debugEl.scrollTop = debugEl.scrollHeight;
            }
        }

        // ‚≠ê VALIDACI√ìN INICIAL
        log(`Iniciando puente.html - ID: ${juegoId || 'N/A'}`);
        
        if (!juegoId && !destino) {
            showError("‚ùå Error cr√≠tico: No se proporcion√≥ ID del juego ni enlace de destino");
            log("Sin ID ni destino", 'error');
        } else {
            log(`Par√°metros recibidos OK - ID: ${juegoId}`);
        }

        // ‚≠ê COUNTDOWN TIMER
        const interval = setInterval(() => {
            countdown--;
            timerEl.innerText = `Preparando enlace en ${countdown}...`;
            
            if (countdown <= 0) {
                clearInterval(interval);
                timerEl.style.display = 'none';
                btnEl.style.display = 'block';
                
                log("Timer completado, iniciando validaci√≥n");
                
                // ‚≠ê VALIDAR DESCARGA EN EL BACKEND
                if (juegoId) {
                    validarDescarga(juegoId);
                } else if (destino) {
                    // Modo legacy (sin econom√≠a)
                    log("Modo legacy activado");
                    enlaceFinal = decodeURIComponent(destino);
                    habilitarBoton();
                }
            }
        }, 1000);

        // ‚≠ê FUNCI√ìN PRINCIPAL: VALIDAR DESCARGA
        async function validarDescarga(juegoId) {
            if (validacionRealizada) {
                log("Validaci√≥n ya realizada, ignorando");
                return;
            }
            
            validacionRealizada = true;
            btnEl.disabled = true;
            btnEl.innerText = "‚è≥ Validando descarga...";
            
            log(`Enviando petici√≥n al backend - Juego ID: ${juegoId}`);
            
            try {
                const requestBody = { juegoId };
                log(`Body de la petici√≥n: ${JSON.stringify(requestBody)}`);
                
                const response = await fetch(`${API_URL}/economia/validar-descarga`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                log(`Respuesta recibida - Status: ${response.status}`);

                // ‚≠ê MANEJAR ERRORES HTTP
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`Error HTTP ${response.status}: ${errorText}`, 'error');
                    throw new Error(`Error HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                log(`Datos recibidos: ${JSON.stringify(data)}`, 'success');

                if (data.success) {
                    // ‚≠ê CR√çTICO: Asignar el enlace primero
                    enlaceFinal = data.link;
                    
                    // ‚≠ê VALIDAR que el enlace existe Y es una URL v√°lida
                    if (!enlaceFinal || enlaceFinal.trim() === '') {
                        log(`‚ö†Ô∏è Backend no devolvi√≥ enlace. Data completa: ${JSON.stringify(data)}`, 'error');
                        showError("‚ùå Error: El backend no devolvi√≥ un enlace de descarga v√°lido");
                        btnEl.disabled = true;
                        btnEl.innerText = "Error - Sin enlace";
                        return;
                    }
                    
                    log(`‚úÖ Enlace recibido: ${enlaceFinal.substring(0, 50)}...`, 'success');
                    
                    // ‚≠ê MOSTRAR MENSAJE SEG√öN EL ESTADO
                    if (data.limiteAlcanzado) {
                        showWarning("‚ö†Ô∏è " + (data.mensaje || "Ya descargaste este juego 2 veces hoy. A√∫n puedes acceder al enlace."));
                        log("L√≠mite alcanzado pero enlace permitido", 'info');
                    } else {
                        showSuccess(`‚úÖ Descarga validada (${data.descargasEfectivas || 'N/A'} descargas efectivas)`);
                        log(`Descarga contada - Total: ${data.descargasEfectivas}`, 'success');
                    }
                    
                    // ‚≠ê SIEMPRE HABILITAR EL BOT√ìN si tenemos enlace
                    habilitarBoton();
                    
                } else {
                    const errorMsg = data.error || data.mensaje || "Error desconocido al validar descarga";
                    log(`Error en respuesta: ${errorMsg}`, 'error');
                    showError("‚ùå " + errorMsg);
                    btnEl.disabled = true;
                    btnEl.innerText = "Error en validaci√≥n";
                }
                
            } catch (error) {
                log(`Error cr√≠tico: ${error.message}`, 'error');
                console.error("‚ùå Error completo:", error);
                
                let errorMessage = "Error de conexi√≥n con el servidor";
                
                if (error.message.includes("Failed to fetch")) {
                    errorMessage = "No se pudo conectar al servidor. Verifica tu conexi√≥n a internet.";
                } else if (error.message.includes("NetworkError")) {
                    errorMessage = "Error de red. El servidor puede estar ca√≠do.";
                } else if (error.message.includes("HTTP 4")) {
                    errorMessage = "Petici√≥n inv√°lida. Verifica el ID del juego.";
                } else if (error.message.includes("HTTP 5")) {
                    errorMessage = "Error del servidor. Intenta de nuevo en unos minutos.";
                }
                
                showError(`‚ùå ${errorMessage}`);
                btnEl.disabled = true;
                btnEl.innerText = "Validaci√≥n fallida";
            }
        }

        // ‚≠ê HABILITAR BOT√ìN DE DESCARGA
        function habilitarBoton() {
            btnEl.disabled = false;
            btnEl.innerText = "üöÄ Obtener Enlace";
            btnEl.style.display = 'block';
            
            log("Bot√≥n habilitado", 'success');
            
            btnEl.onclick = () => {
                if (enlaceFinal) {
                    log(`Abriendo enlace: ${enlaceFinal}`);
                    
                    // Abrir en nueva pesta√±a
                    const nuevaVentana = window.open(enlaceFinal, '_blank');
                    
                    if (nuevaVentana) {
                        timerEl.style.display = 'block';
                        timerEl.innerText = "‚úÖ Enlace abierto en nueva pesta√±a";
                        timerEl.style.color = "var(--neon-green)";
                        btnEl.innerText = "üîÑ Volver a abrir";
                        log("Enlace abierto correctamente", 'success');
                    } else {
                        showError("‚ö†Ô∏è El navegador bloque√≥ la ventana emergente. Permite ventanas emergentes para este sitio.");
                        log("Popup bloqueado", 'error');
                    }
                } else {
                    showError("‚ùå Error: Enlace no disponible");
                    log("Intento de click sin enlace", 'error');
                }
            };
        }

        // ‚≠ê FUNCIONES DE UI
        function showError(msg) {
            errorEl.innerText = msg;
            errorEl.style.display = 'block';
            successEl.style.display = 'none';
        }

        function showSuccess(msg) {
            successEl.innerText = msg;
            successEl.style.display = 'block';
            errorEl.style.display = 'none';
        }

        function showWarning(msg) {
            timerEl.innerText = msg;
            timerEl.style.color = "#ffcc00";
            timerEl.style.display = 'block';
        }
        
        // ‚≠ê LOG FINAL DE INICIALIZACI√ìN
        log("Puente.html inicializado completamente");
    </script>

</body>
</html>
